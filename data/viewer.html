<!DOCTYPE HTML>
<html>
<head>
  <title>Historical Data Viewer - MPU6050 Data Logger</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="uPlot.min.css">
  <style>
    /* --- General Layout --- */
    body { 
      font-family: Arial, sans-serif; 
      margin: 0; 
      padding: 10px; 
      background-color: #f2f2f2; 
      color: #333;
    }
    .container { max-width: 1400px; margin: 0 auto; }
    
    /* --- Header --- */
    .header { 
      background: white; 
      padding: 15px; 
      margin-bottom: 15px; 
      border-radius: 8px; 
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 10px;
    }
    .header h1 {
      margin: 0;
      font-size: 1.5rem;
      flex-grow: 1;
      text-align: center;
    }
    .back-link {
      padding: 8px 16px;
      background-color: #007bff;
      color: white;
      text-decoration: none;
      border-radius: 4px;
      font-size: 14px;
      white-space: nowrap;
    }
    .back-link:hover { background-color: #0056b3; }

    /* --- Controls Area (NEW LAYOUT) --- */
    .controls {
      background: white;
      padding: 20px;
      margin-bottom: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
    }

    /* Logical Sections (e.g., File Select, Actions, Download) */
    .control-section {
      display: flex;
      gap: 10px;
      align-items: flex-end; /* Aligns buttons with input fields */
      padding-right: 20px;
      border-right: 1px solid #e0e0e0;
    }
    .control-section:last-of-type {
      border-right: none;
      padding-right: 0;
    }

    /* Vertical grouping for Label + Input */
    .input-group {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }
    .input-group label {
      font-size: 0.85rem;
      font-weight: 600;
      color: #666;
    }
    .input-group select {
      padding: 0 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      height: 36px;
      font-size: 14px;
      min-width: 200px;
    }

    /* Button Styling */
    .button { 
      background-color: #007bff; 
      color: white; 
      border: none; 
      padding: 0 16px; 
      height: 36px; /* Matches input height */
      border-radius: 4px; 
      cursor: pointer; 
      font-size: 14px;
      font-weight: 500;
      white-space: nowrap;
      transition: background-color 0.2s;
    }
    .button:hover { background-color: #0056b3; }
    .button:disabled { background-color: #6c757d; cursor: not-allowed; opacity: 0.7; }
    .button.danger { background-color: #dc3545; }
    .button.danger:hover { background-color: #c82333; }

    /* Grouping buttons visually */
    .btn-group {
      display: flex;
      gap: 5px;
    }
    
    /* Search Box styling matches inputs */
    .search-box {
      padding: 0 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      height: 36px;
      font-size: 14px;
      min-width: 200px;
    }

    /* Status and Progress Bar Area */
    .status-area {
      flex-basis: 100%;
      margin-top: 10px;
      padding-top: 15px;
      border-top: 1px solid #eee;
    }
    .progress {
      width: 100%;
      height: 8px;
      background-color: #e9ecef;
      border-radius: 4px;
      overflow: hidden;
      margin-bottom: 10px;
    }
    .progress-bar {
      height: 100%;
      background-color: #007bff;
      width: 0%;
      transition: width 0.3s ease;
    }
    .status {
      padding: 10px;
      border-radius: 4px;
      font-size: 0.95rem;
    }
    .status.info { background-color: #e2f3f5; color: #0c5460; }
    .status.success { background-color: #d4edda; color: #155724; }
    .status.warning { background-color: #fff3cd; color: #856404; }
    .status.error { background-color: #f8d7da; color: #721c24; }
    .file-info {
      font-size: 0.9rem;
      color: #666;
      margin-top: 5px;
    }

    /* --- Mobile Responsive Rules --- */
    @media (max-width: 900px) {
      .header { flex-direction: column; text-align: center; }
      .header h1 { font-size: 1.2rem; }
      
      .controls { flex-direction: column; gap: 0; padding: 15px; }
      
      .control-section {
        flex-direction: column;
        align-items: stretch;
        border-right: none;
        border-bottom: 1px solid #eee;
        padding: 15px 0;
        width: 100%;
      }
      .control-section:last-of-type { border-bottom: none; }
      
      .input-group select, .search-box { width: 100%; box-sizing: border-box; }
      
      .btn-group { display: flex; width: 100%; gap: 10px; }
      .btn-group .button { flex: 1; } /* Buttons share width */
      
      .button { width: 100%; margin-top: 5px; }
      .btn-group .button { margin-top: 0; }
    }

    /* --- Charts --- */
    .chart-container {
      background: white;
      padding: 15px;
      margin-bottom: 10px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .chart-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 15px;
    }
    @media (min-width: 1200px) {
      .chart-grid { grid-template-columns: 1fr 1fr; }
    }
    .chart-title {
      font-size: 1rem;
      font-weight: bold;
      margin-bottom: 10px;
      text-align: center;
    }
    .plot { width: 100%; }
    .uplot { display: flex !important; flex-direction: column; }
    .u-wrap { order: 1; }
    .u-legend {
      order: 2;
      position: static !important;
      transform: none !important;
      background: transparent !important;
      border: none !important;
      margin-top: 10px;
      text-align: center;
      width: 100%;
      font-size: 13px;
    }
    .u-legend tr { display: inline-block; margin-right: 15px; cursor: pointer; }
    .u-legend tr:first-child { display: none; }

    .chart-controls { display: flex; justify-content: center; margin-top: 10px; }
    .zoom-controls { display: flex; gap: 5px; }
    .zoom-controls button { padding: 4px 12px; height: 28px; font-size: 12px; }

    /* --- Table --- */
    .table-container {
      background: white;
      padding: 15px;
      margin-bottom: 10px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      overflow-x: auto;
    }
    .table-title { font-size: 1rem; font-weight: bold; margin-bottom: 10px; text-align: center; }
    .table-controls {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      flex-wrap: wrap;
      gap: 10px;
    }
    .data-table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
    .data-table th, .data-table td { padding: 10px; text-align: left; border-bottom: 1px solid #eee; }
    .data-table th {
      background-color: #f8f9fa;
      font-weight: bold;
      position: sticky;
      top: 0;
      cursor: pointer;
      user-select: none;
    }
    .data-table th:hover { background-color: #e9ecef; }
    .data-table tr:hover { background-color: #f8f9fa; }
    
    .pagination { display: flex; gap: 5px; align-items: center; }
    .pagination button { min-width: 32px; padding: 0 8px; }
    .pagination-info { font-size: 0.9rem; color: #666; margin: 0 10px; }
    .sort-indicator { margin-left: 5px; font-size: 0.8em; color: #666; }

    /* --- Utilities --- */
    .online-only { }
    .offline-only { display: none; }
    .offline-mode .online-only { display: none; }
    .offline-mode .offline-only { display: block; } /* Changed to block for layout */
    .offline-indicator { color: #dc3545; font-weight: bold; font-size: 0.9em; margin-left: 10px; }
  </style>
</head>
<body>
  <div class="container">
    
    <!-- Header -->
    <div class="header">
      <a href="/" class="back-link online-only">&lt; Back to Main</a>
      <h1>Recorded Data Viewer <span id="offline-indicator" class="offline-indicator offline-only">(Offline)</span></h1>
    </div>

    <!-- Improved Controls Layout -->
    <div class="controls">
      
      <!-- Section 1: File Selection (Visible only when Online) -->
      <div class="control-section online-only">
        <div class="input-group">
          <label for="file-select">Select Log File:</label>
          <select id="file-select" onchange="handleFileSelection()">
            <option value="">Loading files...</option>
          </select>
        </div>
        <div class="btn-group">
          <button class="button" onclick="loadSelectedFile()" id="load-btn">Open</button>
          <button class="button danger" onclick="deleteSelectedFile()" id="delete-btn" disabled>Delete</button>
        </div>
      </div>

      <!-- Section 2: Actions & View Controls -->
      <div class="control-section">
        <div class="input-group">
          <!-- Empty label to maintain vertical alignment with file select -->
          <label style="visibility: hidden;">Local</label>
          <button class="button" onclick="loadLocalFile()" id="local-load-btn">Load Local File...</button>
        </div>
        
        <button class="button offline-only" onclick="retryServerConnection()" id="retry-btn">Retry Connection</button>
        
        <div class="btn-group">
          <button class="button" onclick="showTableView()" id="table-btn" disabled>Data Table</button>
          <button class="button" onclick="showChartView()" id="chart-btn" disabled>Charts</button>
        </div>
      </div>

      <!-- Section 3: Downloads -->
      <div class="control-section">
        <div class="input-group">
          <label>Download:</label>
          <div class="btn-group">
            <button class="button" onclick="downloadAsJSON()" id="download-btn" disabled>JSON</button>
            <button class="button online-only" onclick="downloadBinFile()" id="download-bin-btn" disabled>BIN</button>
          </div>
        </div>
      </div>
    
      <!-- Status & Progress (Full Width) -->
      <div class="status-area">
        <div class="progress" id="loading-progress" style="display: none;">
          <div class="progress-bar" id="loading-progress-bar"></div>
        </div>
        <div id="status" class="status info">Select a file to view historical data</div>
        <div id="file-info" class="file-info"></div>
      </div>
    </div>

    <!-- Charts Section -->
    <div class="chart-grid" id="charts" style="display: none;">
      <div class="chart-container">
        <div class="chart-title">Acceleration (G)</div>
        <div id="accel-plot" class="plot"></div>
        <div class="chart-controls">
          <div class="zoom-controls">
            <button class="button" onclick="zoomIn('accel')">Zoom In</button>
            <button class="button" onclick="zoomOut('accel')">Zoom Out</button>
            <button class="button" onclick="resetZoom('accel')">Reset</button>
          </div>
        </div>
      </div>
      
      <div class="chart-container">
        <div class="chart-title">Gyros (deg/sec)</div>
        <div id="gyros-plot" class="plot"></div>
        <div class="chart-controls">
          <div class="zoom-controls">
            <button class="button" onclick="zoomIn('orientation')">Zoom In</button>
            <button class="button" onclick="zoomOut('orientation')">Zoom Out</button>
            <button class="button" onclick="resetZoom('orientation')">Reset</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Table Section -->
    <div class="table-container" id="table-container" style="display: none;">
      <div class="table-title">Sensor Data Table</div>
      <div class="table-controls">
        <input type="text" class="search-box" id="search-box" placeholder="Search data..." onkeyup="searchTable()">
        <div class="pagination">
          <button class="button" onclick="firstPage()" id="first-btn"><<</button>
          <button class="button" onclick="previousPage()" id="prev-btn"><</button>
          <span class="pagination-info" id="page-info">Page 1 of 1</span>
          <button class="button" onclick="nextPage()" id="next-btn">></button>
          <button class="button" onclick="lastPage()" id="last-btn">>></button>
        </div>
      </div>
      <table class="data-table" id="data-table">
        <thead>
          <tr>
            <th onclick="sortTable(0)">Time (s) <span class="sort-indicator" id="sort-0"></span></th>
            <th onclick="sortTable(1)">Delay (s) <span class="sort-indicator" id="sort-1"></span></th>
            <th onclick="sortTable(2)">Accel X (G) <span class="sort-indicator" id="sort-2"></span></th>
            <th onclick="sortTable(3)">Accel Y (G) <span class="sort-indicator" id="sort-3"></span></th>
            <th onclick="sortTable(4)">Accel Z (G) <span class="sort-indicator" id="sort-4"></span></th>
            <th onclick="sortTable(5)">Yaw (°) <span class="sort-indicator" id="sort-5"></span></th>
            <th onclick="sortTable(6)">Pitch (°) <span class="sort-indicator" id="sort-6"></span></th>
            <th onclick="sortTable(7)">Roll (°) <span class="sort-indicator" id="sort-7"></span></th>
            <th onclick="sortTable(8)">Flags <span class="sort-indicator" id="sort-8"></span></th>
          </tr>
        </thead>
        <tbody id="table-body">
        </tbody>
      </table>
    </div>
  </div>

  <script src="uPlot.iife.min.js"></script>
  <script src="viewer-core.js"></script>
  <script src="viewer-table.js"></script>
  <input type="file" id="local-file-input" accept=".bin" style="display: none;" onchange="handleLocalFileSelection(event)">
</body>
</html>
